<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
		<title>Grabpack In Godot</title>
		<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@700&display=swap');

html, body, #canvas {
	margin: 0;
	padding: 0;
	border: 0;
}

body {
	color: white;
	background-color: black;
	overflow: hidden;
	touch-action: none;
}

#canvas {
	display: block;
}

#canvas:focus {
	outline: none;
}

#status {
	position: absolute;
	left: 0; right: 0; top: 0; bottom: 0;
	background-color: #0a0a0f;
	display: flex;
	flex-direction: column;
	justify-content: center;
	align-items: center;
}

#status::before {
	content: '';
	position: absolute;
	inset: 0;
	background-image:
		linear-gradient(rgba(255, 60, 60, 0.04) 1px, transparent 1px),
		linear-gradient(90deg, rgba(255, 60, 60, 0.04) 1px, transparent 1px);
	background-size: 40px 40px;
	pointer-events: none;
}

#status-splash {
	position: relative;
	max-height: 50%;
	max-width: 65%;
	object-fit: contain;
	filter: drop-shadow(0 0 30px rgba(255, 60, 60, 0.4));
	animation: float 3s ease-in-out infinite;
	margin-bottom: 2.5rem;
}

@keyframes float {
	0%, 100% { transform: translateY(0px); }
	50% { transform: translateY(-8px); }
}

#custom-loader {
	display: flex;
	flex-direction: column;
	align-items: center;
	gap: 14px;
	width: 420px;
	max-width: 90vw;
	position: relative;
}

.loader-title {
	font-family: 'Orbitron', monospace;
	font-size: 11px;
	letter-spacing: 0.3em;
	text-transform: uppercase;
	color: rgba(255, 255, 255, 0.35);
	margin-bottom: 2px;
}

.loader-bar-wrap {
	width: 100%;
	height: 6px;
	background: rgba(255, 255, 255, 0.07);
	border-radius: 3px;
	overflow: hidden;
	position: relative;
}

.loader-bar-fill {
	height: 100%;
	width: 0%;
	background: linear-gradient(90deg, #ff2020, #ff6060);
	border-radius: 3px;
	transition: width 0.3s ease;
	box-shadow: 0 0 12px rgba(255, 40, 40, 0.8);
	position: relative;
}

.loader-bar-fill.indeterminate {
	width: 30% !important;
	animation: slide-indeterminate 1.4s ease-in-out infinite;
}

@keyframes slide-indeterminate {
	0% { transform: translateX(-200%); }
	100% { transform: translateX(500%); }
}

.loader-stats {
	display: flex;
	justify-content: space-between;
	width: 100%;
	font-family: 'Share Tech Mono', monospace;
	font-size: 13px;
}

.loader-mb { color: #ff5555; }
.loader-pct { color: rgba(255, 255, 255, 0.5); }

.loader-dots {
	display: flex;
	gap: 6px;
	margin-top: 4px;
}

.loader-dot {
	width: 5px;
	height: 5px;
	border-radius: 50%;
	background: #ff3333;
	animation: pulse-dot 1.2s ease-in-out infinite;
}

.loader-dot:nth-child(2) { animation-delay: 0.2s; }
.loader-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes pulse-dot {
	0%, 100% { opacity: 0.2; transform: scale(0.8); }
	50% { opacity: 1; transform: scale(1.2); }
}

#status-notice {
	display: none;
	background-color: #3a1010;
	border-radius: 0.5rem;
	border: 1px solid #9b3943;
	color: #e0e0e0;
	font-family: 'Share Tech Mono', monospace;
	line-height: 1.3;
	margin: 0 2rem;
	overflow: hidden;
	padding: 1rem;
	text-align: center;
	position: relative;
	max-width: 80vw;
	white-space: pre-line;
}
		</style>
	</head>
	<body>
		<canvas id="canvas">
			Your browser does not support the canvas tag.
		</canvas>

		<noscript>
			Your browser does not support JavaScript.
		</noscript>

		<div id="status">
			<img id="status-splash" src="Grabpack In Godot.png" alt="">

			<div id="custom-loader">
				<div class="loader-title">Loading Game Assets</div>
				<div class="loader-bar-wrap">
					<div class="loader-bar-fill indeterminate" id="loader-fill"></div>
				</div>
				<div class="loader-stats">
					<span class="loader-mb" id="loader-mb">Connecting...</span>
					<span class="loader-pct" id="loader-pct"></span>
				</div>
				<div class="loader-dots">
					<div class="loader-dot"></div>
					<div class="loader-dot"></div>
					<div class="loader-dot"></div>
				</div>
			</div>

			<div id="status-notice"></div>
			<progress id="status-progress" style="display:none;"></progress>
		</div>

		<script>
(function () {
	const statusOverlay = document.getElementById('status');
	const statusNotice = document.getElementById('status-notice');
	const loaderFill = document.getElementById('loader-fill');
	const loaderMb = document.getElementById('loader-mb');
	const loaderPct = document.getElementById('loader-pct');
	const customLoader = document.getElementById('custom-loader');

	// Total size of pck + wasm in bytes
	const TOTAL_BYTES = 578276348 + 35739700;

	function bytesToMB(bytes) {
		return (bytes / (1024 * 1024)).toFixed(1);
	}

	function updateLoaderProgress(current, total) {
		const t = total > 0 ? total : TOTAL_BYTES;
		if (current > 0) {
			const pct = Math.min(100, Math.round((current / t) * 100));
			loaderFill.classList.remove('indeterminate');
			loaderFill.style.width = pct + '%';
			loaderMb.textContent = bytesToMB(current) + ' MB / ' + bytesToMB(t) + ' MB';
			loaderPct.textContent = pct + '%';
		}
	}

	function showNotice(text) {
		customLoader.style.display = 'none';
		statusNotice.style.display = 'block';
		statusNotice.textContent = text;
	}

	function hideStatus() {
		statusOverlay.style.display = 'none';
	}

	const GODOT_CONFIG = {
		"args": [],
		"canvasResizePolicy": 2,
		"emscriptenPoolSize": 8,
		"ensureCrossOriginIsolationHeaders": true,
		"executable": "Grabpack In Godot",
		"experimentalVK": false,
		"fileSizes": {
			"Grabpack In Godot.pck": 578276348,
			"Grabpack In Godot.wasm": 35739700
		},
		"focusCanvas": true,
		"gdextensionLibs": [],
		"godotPoolSize": 4
	};

	const GODOT_THREADS_ENABLED = false;

	// Dynamically load the engine script, THEN start the game inside onload
	var script = document.createElement('script');
	script.src = 'Grabpack In Godot.js';
	script.onload = function () {
		const engine = new Engine(GODOT_CONFIG);
		const missing = Engine.getMissingFeatures({ threads: GODOT_THREADS_ENABLED });

		if (missing.length !== 0) {
			if (GODOT_CONFIG['serviceWorker'] && GODOT_CONFIG['ensureCrossOriginIsolationHeaders'] && 'serviceWorker' in navigator) {
				let swPromise;
				try {
					swPromise = navigator.serviceWorker.getRegistration();
				} catch (e) {
					swPromise = Promise.reject(new Error('Service worker registration failed.'));
				}
				Promise.race([
					swPromise.then((reg) => {
						if (reg != null) throw new Error('Service worker already exists.');
						return engine.installServiceWorker();
					}),
					new Promise((resolve) => setTimeout(resolve, 2000)),
				]).then(() => {
					window.location.reload();
				}).catch((err) => {
					console.error('Service worker error:', err);
				});
			} else {
				showNotice('Error: Missing browser features:\n' + missing.join('\n'));
			}
		} else {
			engine.startGame({
				onProgress: function (current, total) {
					updateLoaderProgress(current, total);
				},
			}).then(() => {
				hideStatus();
			}).catch((err) => {
				console.error(err);
				showNotice(err instanceof Error ? err.message : 'An unknown error occurred.');
			});
		}
	};
	script.onerror = function () {
		showNotice('Failed to load game engine.\nMake sure "Grabpack In Godot.js" is in the same folder.');
	};
	document.body.appendChild(script);
}());
		</script>
	</body>
</html>
